<!DOCTYPE html>
<html>
<head>
    <title>Skeleton 3d reconstruction</title>
    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/tfjs.js"></script>
    <script src="js/posenet.js"></script>
</head>
<body>
<div id="wrapper" class="centered">
    <p>
        <button onclick="startWebcam();">Start WebCam</button>
        <button onclick="stopWebcam();">Stop WebCam</button>
    </p>
    <div class="video-wrapper local">
        <video style="position: absolute" id="video" autoplay width="800px" height="500px" controls autoplay></video>
        <canvas style="position: absolute" id="myCanvas" width="700"></canvas>
    </div>
</div>

<script>
    let localStream;
    let networks;
    let currentAnimationId;

    const joints16 = [
        "nose",
        "leftShoulder",
        "rightShoulder",
        "leftElbow",
        "rightElbow",
        "leftWrist",
        "rightWrist",
        "leftHip",
        "rightHip",
        "leftKnee",
        "rightKnee",
        "leftAnkle",
        "rightAnkle",
    ];

    const scaleFactor = 0.50;
    const flipHorizontal = false;
    const outputStride = 8;
    const imageElement = document.getElementById('video');

    function startWebcam() {
        if (navigator.getUserMedia) {
            navigator.getUserMedia(
                {video: true, audio: true},
                stream => {
                    localStream = stream;
                    $('.local video').attr('src', URL.createObjectURL(stream));

                    // load the posenet model
                    posenet.load().then(function (net) {
                        // posenet model loaded
                        networks = net;
                        drawToCanvas();
                    });

                },
                error => {
                    alert('error while accessing usermedia ' + error.toString());
                }
            );
        } else {
            console.log("getUserMedia not supported");
        }
    }

    function stopWebcam() {
        try {
            localStream.stop();
        } catch (e) {
            console.log(e);
            if (localStream) {
                localStream.getTracks().forEach(function (track) {
                    track.stop();
                });
            }
        }
        localStream = undefined;
    }

    function drawToCanvas() {

        if (!localStream) {
            window.cancelAnimationFrame(currentAnimationId);
            return;
        }

        networks.estimateSinglePose(imageElement, scaleFactor, flipHorizontal, outputStride).then(function (result) {

            console.log(result);

            let joints = result["keypoints"];

            let canvas = document.getElementById("myCanvas");
            let ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let i = 0; i < joints.length; ++i) {

                if (joints16.indexOf(joints[i]["part"]) === -1 || joints[i]["score"] < 0.8)
                    continue;

                ctx.beginPath();
                ctx.arc(joints[i].position.x, joints[i].position.y, 2, 0, Math.PI * 2, true);
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#00ff00';
                ctx.stroke();
            }
            currentAnimationId = requestAnimationFrame(drawToCanvas);
        });
    }
</script>
</body>
</html>